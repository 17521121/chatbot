<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {{ fontawesome_html() }}
    <link rel="stylesheet" href=" {{ url_for('static', filename = 'style.css') }}">
    <title>Chatbot</title>
</head>

<body>
    <div class="container">
        <div class="chatbox">
            <div class="show_text">
            </div>
        </div>

    </div>
    <div class="input_box">
        <div class="input_holder">
            <textarea name="chat_text" rows="2" class="chat_text" onkeypress="return submit_chat(event)"></textarea>
        </div>

        <div class="icon_send" onclick="click_submit()">
            <a href="javascript:void(0)">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
            </a>
        </div>

    </div>
    <div class="pronoun">
        <div class="n2">

            <img src="{{ url_for('static', filename = 'img/robot_chat.png') }}" width="100px" height="100px" alt="">
            <select class="select-css" name="n2" id="n2" onchange="n2_change()">
                <option value="tôi-bạn">tôi-bạn</option>
                <option value="tao-mày">tao-mày</option>
                <option value="t-m">t-m</option>
                <option value="anh-em">anh-em</option>
                <option value="chị-em">chị-em</option>
                <option value="mẹ-con">mẹ-con</option>
                <option value="ba-con">ba-con</option>
                <option value="chú-cháu">chú-cháu</option>
                <option value="cô-cháu">cô-cháu</option>
                <option value="em-anh">em-anh</option>
                <option value="em-chị">em-chị</option>
                <option value="con-mẹ">con-mẹ</option>
                <option value="con-ba">con-ba</option>
                <option value="cháu-chú">cháu-chú</option>
                <option value="cháu-cô">cháu-cô</option>
              </select>
        </div>
        <div class="arrow">
            <span>&uarr;</span>
        </div>
        <div class="n1">
            <img src="{{ url_for('static', filename = 'img/human_chat.png') }}" width="100px" height="100px" alt="">
            <select class="select-css" name="n1" id="n1" onchange="n1_change()">
                <option value="tôi-bạn">tôi-bạn</option>
                <option value="tao-mày">tao-mày</option>
                <option value="t-m">t-m</option>
                <option value="em-anh">em-anh</option>
                <option value="em-chị">em-chị</option>
                <option value="con-mẹ">con-mẹ</option>
                <option value="con-ba">con-ba</option>
                <option value="cháu-chú">cháu-chú</option>
                <option value="cháu-cô">cháu-cô</option>
                <option value="anh-em">anh-em</option>
                <option value="chị-em">chị-em</option>
                <option value="mẹ-con">mẹ-con</option>
                <option value="ba-con">ba-con</option>
                <option value="chú-cháu">chú-cháu</option>
                <option value="cô-cháu">cô-cháu</option>
            </select>
        </div>
    </div>
    <div class="end_chat" onclick="end_chat()">
        <a href="javascript:void(0)">
            Kết thúc!
        </a>
    </div>
    <script src="{{ url_for('static', filename = 'jquery-3.5.1.min.js') }}"></script>
    <script>
        let ctx = []
        let res=  []
        let emo = ["neutral"]
        // text trong khung chát
        let show_text = document.getElementsByClassName('show_text')[0]
        let n1 = document.getElementById("n1")
        let n2 = document.getElementById("n2")
        let chat_text = document.getElementsByClassName("chat_text")[0]

        function n1_change() {
            n2.selectedIndex = n1.selectedIndex 
        }
        function n2_change() {
            n1.selectedIndex = n2.selectedIndex 
        }

        function end_chat() {
            let data = { "n1": n1.value, "n2": n2.value, "emo_text": emo[emo.length - 1]}
            $.post(
                "bye_chatbot",
                data,
                function (data) { //thành công
                    
                    //add chat lên khung
                    show_text.innerHTML += `
                        <div class="left">
                            ${data}
                        </div>
                    `
                    //Kéo scroll xuống cuối
                    $('.show_text').stop().animate({
                        scrollTop: $('.show_text')[0].scrollHeight
                    }, 800);
                }
            )
        }

        function keep_conversation() {
            let data = { "n1": n1.value, "n2": n2.value, "emo_text": emo[emo.length - 1]}
            $.post(
                "keep_conversation_chatbot",
                data,
                function (data) { //thành công
                    
                    //add chat lên khung
                    show_text.innerHTML += `
                        <div class="left">
                            ${data}
                        </div>
                    `
                    //Kéo scroll xuống cuối
                    $('.show_text').stop().animate({
                        scrollTop: $('.show_text')[0].scrollHeight
                    }, 800);
                }
            )
        }

        function start_chat() {
            $.post(
                "hello_chatbot",
                {},
                function (data) { //thành công
                    
                    //add chat lên khung
                    show_text.innerHTML += `
                        <div class="left">
                            ${data}
                        </div>
                    `
                    //Kéo scroll xuống cuối
                    $('.show_text').stop().animate({
                        scrollTop: $('.show_text')[0].scrollHeight
                    }, 800);
                }
            )
        }

        start_chat()

        function send_chat() {
            let send_text = [];
            // if (res.length > 0) {
            //     send_text = [ctx[ctx.length - 1], res[res.length - 1], chat_text.value.trim()]
            // }
            // else {
            //     send_text = [chat_text.value.trim()]
            // }
            
            send_text = [chat_text.value.trim().replace("?", "").replace("!", "")] //turn = 1
            ctx.push(send_text[send_text.length - 1])
            let data = { "n1": n1.value, "n2": n2.value, "chat_text": send_text.join(" | ") }
            
            //add chat lên khung
            show_text.innerHTML += `
                        <div class="right">
                            ${ctx[ctx.length - 1]}
                        </div>
                    `
            
            //Kéo scroll xuống cuối
            $('.show_text').stop().animate({
                scrollTop: $('.show_text')[0].scrollHeight
            }, 800);

            //xoá chat trong khung chat
            chat_text.value = ""

            $.post(
                "chat",
                data,

                function (data) { //thành công
                    // lưu lại history
                    
                    res.push(data.text)
                    emo.push(data.emo_text)
                    //add chat lên khung
                    show_text.innerHTML += `
                        <div class="left">
                            ${data.text}
                        </div>
                    `

                    //Kéo scroll xuống cuối
                    $('.show_text').stop().animate({
                        scrollTop: $('.show_text')[0].scrollHeight
                    }, 800);
                }
            )

            clearInterval(keep_conversation);
            setInterval(keep_conversation, 20000);
        }

        function submit_chat(e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                if (chat_text.value.trim() == "")
                    return
                //Shift enter skip
                if (e.shiftKey) {
                    return
                }
                //Xử lí api
                send_chat()
            }

        }

        function click_submit() {

            if (chat_text.value.trim() == "")
                return
            //Xử lí api
            send_chat()
        }
   

   </script>


</body>

</html>